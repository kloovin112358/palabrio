<!DOCTYPE html>
<html>
<!-- Palabrio, created in 2020-2021 by Kevin Lauer and Emily Lucas. Music by Colin Winkelmann.  -->
<title>palabr.io</title>
<link rel='icon' href='/client/palabricon.png'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href='/client/palabristyle.css'>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Varela+Round">
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script> 

	var socket = io();

	socket.on('checkCookie', function() {
		var username = getCookie('username')
		var gamecode = getCookie('gamecode')
		socket.emit('checkedCookie', {username, gamecode})
	});

	socket.on('addCookies', function(data) {
		setCookie('username', data.shortGuy, 30);
		setCookie('gamecode', data.game_code, 30);
	});

	function setCookie(cname,cvalue,minutes) {
		var d = new Date();
		d.setTime(d.getTime() + (minutes*60*1000));
		var expires = "expires=" + d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
	}

	function getCookie(cname) {
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for(var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
			c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
			}
		}
		return "";
	}

	$(document).ready(function() {
		document.body.addEventListener("click", playMusic)
	});

	function playMusic() {
		$('audio#music')[0].play()
		document.body.removeEventListener("click", playMusic)
	}

	var playerCounter = 0 

	var create_lobby = function() {
		document.getElementById('errorMsg').style.display = 'none';
		var username = document.getElementById("username").value;
		if (username != '') {
			socket.emit('createLobby', {username});
			document.getElementById('shortnameID').innerHTML = username
			createdLobby(username)
		} else {
			changeError('Please submit a username');
		}
	};

	function createdLobby(shortname) {
		document.getElementById("username").style.display = 'none';
		document.getElementById("afterCreatedUsername").style.display = 'inherit';
		document.getElementById("afterCreatedUsername").innerHTML = shortname
		document.getElementById("btnLobby").disabled = 'disabled';
		document.getElementById('btnJoinExisting').style.display = 'none';
		document.getElementById('joinCode').style.display = 'none';
		document.getElementById('btnLobby').style.display = 'none';
		document.getElementById('startGame').style.display = 'block';
	}

	var join_game = function() {
		document.getElementById('errorMsg').style.display = 'none';
		var gamecode = document.getElementById("joinCode").value;
		var username = document.getElementById("username").value;
		if (username != '') {
			if (gamecode != '') {
				socket.emit('joinGame', {gamecode, username});
				document.getElementById('shortnameID').innerHTML = username
			} else {
				changeError('Please submit a Game ID');
			}
		} else {
			changeError('Please submit a username');
		}
		
	};

	var copy_code = function() {
		var tempInput = document.createElement("input");
		var gamecode = document.getElementById('shareCode').innerHTML;
		gamecode = gamecode.replace('Game ID: ', '');
	  	tempInput.value = gamecode;
	  	document.body.appendChild(tempInput);
	  	tempInput.select();
	  	document.execCommand("copy");
	  	document.body.removeChild(tempInput);
	  	document.getElementById('copyGameCode').innerHTML = 'Copied!';
	};

	var start_game = function() {
		var familyStatus = document.getElementById('familyFilter').checked
		var getToKnowYouStatus = document.getElementById('getToKnowYouFilter').checked
		socket.emit('startGame', {familyStatus, getToKnowYouStatus});
	};

	var send_ans = function() {

		var answer1 = document.getElementById("answer1").value;
		var answer2 = document.getElementById("answer2").value;
		var answer3 = document.getElementById("answer3").value;

		if (document.getElementById('timeOut').innerHTML == 'false') {
			stopTimer();
		}

		if ((answer1 == '' || answer2 == '' || answer3 == '') && (document.getElementById('timeOut').innerHTML != 'true')) {
			document.getElementById('needAnswers').style.display = 'block';
		} else {

			if (document.getElementById('timeOut').innerHTML == 'true') {

				if (answer1 == '') {
					answer1 = document.getElementById('cannedAnswer1').innerHTML
				}

				if (answer2 == '') {
					answer2 = document.getElementById('cannedAnswer2').innerHTML
				}

				if (answer3 == '') {
					answer3 = document.getElementById('cannedAnswer3').innerHTML
				}

				document.getElementById('timeOut').innerHTML == 'false'
			} 

			socket.emit('receiveAnswers', {answer1, answer2, answer3});
			document.getElementById('round1').style.display = 'none';
			document.getElementById('instructions').innerHTML = 'That wasn\'t too difficult, now was it?'
			document.getElementById('waitingScreen').style.display = 'inherit';

			document.getElementById('answer1').value = "";
			document.getElementById('answer2').value = "";
			document.getElementById('answer3').value = "";

		};

	};

	var send_questions = function() {
		var question1 = document.getElementById('question11').value;
		var question2 = document.getElementById('question21').value;
		var question3 = document.getElementById('question31').value;

		if (document.getElementById('timeOut').innerHTML == 'false') {
			stopTimer();
		}

		if ((question1 == '' || question2 == '' || question3 == '') && document.getElementById('timeOut').innerHTML != 'true') {
			document.getElementById('needAnswers1').style.display = 'inherit';
		} else {
			if (question1 == '') {
				question1 = 'No question submitted. :('
			}

			if (question2 == '') {
				question2 = 'No question submitted. :('
			}

			if (question3 == '') {
				question3 = 'No question submitted. :('
			}

			document.getElementById('timeOut').innerHTML = 'false'

			socket.emit('submitQuestions', {question1, question2, question3});
			document.getElementById('round6').style.display = 'none';
			document.getElementById('instructions').innerHTML = 'Good job, you\'re all done with the difficult stuff.'
			document.getElementById('waitingScreen').style.display = 'inherit';

			document.getElementById('question11').value = "";
			document.getElementById('question21').value = "";
			document.getElementById('question31').value = "";
		}
	};

	var nextQuestion = function() {
		socket.emit('goToNextQuestion')
	}

	var send_story = function() {

		var story = document.getElementById('story').value;
		var story_title = document.getElementById('storyTitle').value;

		if (document.getElementById('timeOut').innerHTML == 'false') {
			stopTimer();
		}

		if (story == '' && document.getElementById('timeOut').innerHTML != 'true') {
			document.getElementById('needInfo').innerHTML = 'Please write a story.'
			document.getElementById("needInfo").style.display = 'block';
		} else if (story_title == '' && document.getElementById('timeOut').innerHTML != 'true') {
			document.getElementById('needInfo').innerHTML = 'Please title your story.'
			document.getElementById("needInfo").style.display = 'block';
		} else {
			if (document.getElementById('timeOut').innerHTML == 'true') {
				if (story_title == '') {
					story_title = 'No title submitted'
				}

				if (story == '') {
					story = 'No story submitted'
				}

				document.getElementById('timeOut').innerHTML == 'false'
			}

			socket.emit('receiveStory', {story, story_title});
			document.getElementById('round2').style.display = 'none';
			document.getElementById('instructions').innerHTML = 'Wow, you actually had to be creative. Who convinced you to play this, anyway?'
			document.getElementById('waitingScreen').style.display = 'inherit';

			document.getElementById('story').value = "";
			document.getElementById('storyTitle').value = "";
		}
	};

	var doneWithScores = function() {
		socket.emit('doneWithScores');
	}

	var start_making_questions = function() {
		socket.emit('beginMakingQuestions');
	}

	socket.on('receiveCannedAnswer', function(data) {
		var canned1 = data.listRands[0]
		var canned2 = data.listRands[1]
		var canned3 = data.listRands[2]
		document.getElementById('cannedAnswer1').innerHTML = canned1
		document.getElementById('cannedAnswer2').innerHTML = canned2
		document.getElementById('cannedAnswer3').innerHTML = canned3
	})

	socket.on('changingHTML', function() {
		nonHostJoinedLobby()
	});

	function nonHostJoinedLobby() {
		document.getElementById('startMenu').style.display = 'none';
		document.getElementById('headerBig').style.display = 'none';
		document.getElementById('credits').style.display = 'none';
		document.getElementById('headerSmall').style.display = 'inline';
		document.getElementById('gameMenu').style.display = 'block';
	}

	socket.on('addStartDelay', function() {
		initializeTimer(10, readyPlayerOne, 'waitingText', true, "dummy")
	})

	var readyPlayerOne = function() {
		socket.emit('readyPlayerOne');
	}

	socket.on('serverMsg', function(data) {

		var errorElement = document.getElementById('errorMsg')
		errorElement.style.display = 'block';

		switch(data.message) {

			case 'error1':
				errorElement.innerHTML = 'Error: this game does not exist';
				break;
			case 'error2':
				errorElement.innerHTML = 'Error: already in a game';
				break;
			case 'error3':
				errorElement.innerHTML = 'Error: need at least 4 players to start the game';
				break;
			case 'error4':
				errorElement.innerHTML = 'Error: this game is full';
				break;
			case 'error5':
				errorElement.innerHTML = 'Error: this username is already taken';
				break;
			case 'error6':
				errorElement.innerHTML = 'Error: this game has already started';
				break;
			default:
				break;
		}
	});

	socket.on('showID', function(data) {
		document.getElementById('shareCode').style.display = 'block';
		document.getElementById('shareCode').innerHTML = 'Game ID: ' + data.gameId;
		document.getElementById('copyGameCode').style.display = 'block';
	});

	socket.on('joinedLobby', function() {
		joinedLobbyFunction()
	});

	function joinedLobbyFunction() {
		document.getElementById('welcomeText').style.display = 'none';
		document.getElementById('startInputInfo').style.display = 'none';
		document.getElementById('optionsInstructions').style.display = 'none';
		var tempUsername = document.getElementById('shortnameID').innerHTML
		document.getElementById('lobbyJoin').innerHTML = 'Welcome, ' + "<b>" + tempUsername + "</b>" + '! It\'s great to have you. Your host will begin the game soon.'
		document.getElementById('lobbyJoin').style.display = 'block';
	}

	socket.on('transferHost', function(data) {

		document.getElementById('welcomeText').style.display = 'inherit';
		document.getElementById('startInputInfo').style.display = 'grid';
		document.getElementById('optionsInstructions').style.display = 'inherit';
		document.getElementById('lobbyJoin').style.display = 'none';

		document.getElementById("btnLobby").disabled = 'disabled';
		document.getElementById('btnJoinExisting').style.display = 'none';
		document.getElementById('joinCode').style.display = 'none';
		document.getElementById('btnLobby').style.display = 'none';
		document.getElementById('startGame').style.display = 'block';
		document.getElementById('username').style.display = 'none';
		document.getElementById("afterCreatedUsername").style.display = 'inherit';
		document.getElementById("afterCreatedUsername").innerHTML = document.getElementById("shortnameID").innerHTML

		document.getElementById('shareCode').style.display = 'block';
		document.getElementById('shareCode').innerHTML = 'Game ID: ' + data.gameID;
		document.getElementById('copyGameCode').style.display = 'block';

	})

	socket.on('playerUpdate', function(data) {
		document.getElementById('playersList').innerHTML = 'Players in lobby: ' + data.others_list;
		document.getElementById('playersList').style.display = 'block';
	});

	socket.on('addQuestions', function(data) {
		document.getElementById('waitingScreen').style.display = 'none';
		document.getElementById('question1').innerHTML = data.question1
		document.getElementById('question2').innerHTML = data.question2
		document.getElementById('question3').innerHTML = data.question3
		initializeTimer(60, send_ans, "countdownTimerRound1", false, "base-timer-path-remaining");
		document.getElementById('round1').style.display = 'inherit';
	});

	socket.on('startRoundDelay', function(data) {
		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}
		var realFunctionCall = window[data.function_call_when_done];
		initializeTimer(5, realFunctionCall, 'waitingText', true, "dummy")
	});

	socket.on('playerWaitScreen', function(data) {
		nonHostJoinedLobby()
		document.getElementById('shortnameID').innerHTML = data.shortname
		document.getElementById('waitingText').innerHTML = 'Please wait while the current round is being played. You will re-enter the game in the next round.'
		for (var i = 0; i < data.listShortnames.length; i++) {
			addPlayersToSidebar(data.listShortnames[i])
		}
	})

	socket.on('reanimateGhostPlayerForEveryone', function(data) {
		const listOfPlayers = document.getElementById('playersListContainer').childNodes
		for (var i = 0; i < listOfPlayers.length; i++) {
			if (listOfPlayers[i].innerHTML == data.shortname + " (ghost)" ) {
				var actualID = listOfPlayers[i].id
				document.getElementById(actualID).innerHTML = data.shortname
				document.getElementById(actualID).style.fontStyle = 'normal'
				alert("Player " + data.shortname + " has rejoined.")
				//update the id with ghost
			}
		}
	});

	socket.on('showWaitingScreen', function() {
		document.getElementById('round5').style.display = 'none';
		document.getElementById('waitingScreen').style.display = 'inherit';
	})

	function start_story_rd() {
		socket.emit('startStoryRound')
	}

	socket.on('updateGhostPlayer', function(data) {
		const listOfPlayers = document.getElementById('playersListContainer').childNodes
		for (var i = 0; i < listOfPlayers.length; i++) {
			if (listOfPlayers[i].innerHTML == data.ShortName) {
				var actualID = listOfPlayers[i].id
				document.getElementById(actualID).innerHTML = data.ShortName + " (ghost)"
				document.getElementById(actualID).style.fontStyle = 'italic'
				alert("Player " + data.ShortName + " has left the game.")
				//update the id with ghost
			}
		}
	})

	socket.on('addPlayers', function(data) {
		addPlayersToSidebar(data.shortName);
	});

	function addPlayersToSidebar(shortname) {
		playerCounter += 1;
		var htmlID = 'player' + playerCounter;
		var newElement = document.createElement('A');
		newElement.innerHTML = shortname;
		newElement.setAttribute('id',htmlID);
		newElement.setAttribute('style','grid-column: 1;grid-row:' + playerCounter);
		newElement.setAttribute('class','playerItem');
		if (shortname.includes('(ghost)')) {
			newElement.style.fontStyle = 'italic'
		}
		document.getElementById('playersListContainer').appendChild(newElement);
	}

	socket.on('takeAnswers', function(data) {
		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}

		document.getElementById('waitingScreen').style.display = 'none';
		document.getElementById('useAnswers').innerHTML = data.dispAnswer1 + ", " + data.dispAnswer2 + ", " + data.dispAnswer3
		document.getElementById('instructions').innerHTML = 'Here is the tricky part. Incorporate these answers from your friends to write a story. Good luck!'
		initializeTimer(180, send_story, "countdownTimerRound2", false, "base-timer-path-remaining1");
		document.getElementById('round2').style.display = 'inherit';
	});

	socket.on('displayStory', function(data) {
		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}

		document.getElementById('instructions').innerHTML = 'Let\'s see how bad your friends\' stories are.'
		document.getElementById('waitingScreen').style.display = 'none';
		document.getElementById('titleStory').innerHTML = data.story_title
		document.getElementById('storyAuthor').innerHTML = 'By: ' + data.shortName
		document.getElementById('storyDisplay').innerHTML = data.story
		document.getElementById('round3').style.display = 'inherit';
	});

	socket.on('displayScores', function(data) {
		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}

		if (data.lastRoundBoolean) {
			document.getElementById('scoresContinue').style.display = 'none';
			document.getElementById('round7').style.display = 'none';
			document.getElementById('instructions').innerHTML = 'Great job to everyone except last place!'
		} else {
			document.getElementById('instructions').innerHTML = 'It\'s a scientific fact that at least one of you is actually mad that you\'re not winning this party game.'
		}

		document.getElementById('waitingScreen').style.display = 'none';

		var playersScores = data.scores
		var lastScore = 'first'
		var counter = 1

		for (let player in playersScores) {

			var newElement = document.createElement('A');
			newElement.innerHTML = player + ": " + playersScores[player]

			if (lastScore == 'first') {
				lastScore = playersScores[player]
			} else {
				if (lastScore == playersScores[player]) {
					counter -= 1
				}
			}

			switch (counter) {
				case 1:
					newElement.setAttribute('style', 'background-color:#FFD700')
					break;
				case 2:
					newElement.setAttribute('style', 'background-color:#C0C0C0')
					break;
				case 3:
					newElement.setAttribute('style', 'background-color:#cd7f32')
					break;
				default:
					break;
			}

			newElement.setAttribute('class', 'doneScoresItem card')
			document.getElementById('votingContainer').appendChild(newElement)

			counter += 1
			lastScore = playersScores[player]

		};

		document.getElementById('round5').style.display = 'inherit';
	});

	socket.on('addScoringContinue', function(data) {
		document.getElementById('scoresContinue').style.display = 'inherit';
	});

	socket.on('addFinalScreenContinue', function() {
		if (document.getElementById('round8').style.display != 'none') {
			document.getElementById('playAgainButton').style.display = 'inherit';
			document.getElementById('returnLobbyButton').style.display = 'inherit';
		} else {
			document.getElementById('finalScreenContinue').style.display = 'inherit';
		}
	});

	socket.on('startMakingQuestions', function(data) {
		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}

		const votingLists = document.getElementById('votingContainer')
		while (votingLists.firstChild) {
			votingLists.removeChild(votingLists.firstChild);
		}
		
		document.getElementById('waitingScreen').style.display = 'none';

		document.getElementById('answer11').innerHTML = data.ans1
		document.getElementById('answer21').innerHTML = data.ans2
		document.getElementById('answer31').innerHTML = data.ans3

		document.getElementById('instructions').innerHTML = 'Here we go. Now you\'re going to write questions that would make these answers sound ridiculous.'
		initializeTimer(90, send_questions, "countdownTimerRound6", false, "base-timer-path-remaining2");
		document.getElementById('round6').style.display = 'inherit';
	});

	socket.on('displayQuestions', function(data) {

		const waitingList = document.getElementById('listPlayers')
		while (waitingList.firstChild) {
			waitingList.removeChild(waitingList.firstChild);
		}

		document.getElementById('waitingScreen').style.display = 'none';
		document.getElementById('instructions').innerHTML = 'Send an emoji for how funny you think everyone\'s questions were. Or don\'t, if they weren\'t funny.'

		document.getElementById('spotlightID').innerHTML = data.senderPlayer
		document.getElementById('fakeQuestion').innerHTML = '<span style="color:black;font-style:italic;font-weight:400;">' + data.senderShortname + "'s question: " + "</span>" + data.fakeQuestion
		document.getElementById('realAnswer').innerHTML = '<span style="color:black;font-style:italic;">' + data.answererShortname + "'s answer: " + "</span>" + data.realAnswer
		document.getElementById('realQuestion').innerHTML = data.realQuestion

		if (data.senderShortname == document.getElementById('shortnameID').innerHTML) {
			document.getElementById('votingButton1').disabled = true;
			document.getElementById('votingButton2').disabled = true;
			document.getElementById('votingButton3').disabled = true;
		} else {
			document.getElementById('votingButton1').disabled = false;
			document.getElementById('votingButton2').disabled = false;
			document.getElementById('votingButton3').disabled = false;
		}

		document.getElementById('round7').style.display = 'inherit';

	})

	socket.on('addContinueQuestionButton', function() {
		document.getElementById('continueButtonQuestion').style.display = 'inherit';
	});

	socket.on('displayStoryVoting', function(data) {
		document.getElementById('waitingScreen').style.display = 'none';
		document.getElementById('round3').style.display = 'none';

		for (var i = 0; i < data.storiesList.length; i++) {

			var author = data.storiesList[i][1];
			var title = data.storiesList[i][0];

			if (author != data.client_shortname) {
				//only if the player is not the client itself

				var dropDownItem = document.createElement('OPTION');
				dropDownItem.innerHTML = author

				var dropDownItem1 = document.createElement('OPTION');
				dropDownItem1.innerHTML = author

				var dropDownItem2 = document.createElement('OPTION');
				dropDownItem2.innerHTML = author

				document.getElementById('firstDropdown').appendChild(dropDownItem);
				document.getElementById('secondDropdown').appendChild(dropDownItem1);
				document.getElementById('thirdDropdown').appendChild(dropDownItem2);
			}

			var titleAuthorElement = document.createElement('A');
			titleAuthorElement.innerHTML = title + " by: " + author
			titleAuthorElement.setAttribute('class', 'doneTitlesNames card')
			document.getElementById('titlesNames').appendChild(titleAuthorElement)

		};

		document.getElementById("firstDropdown").selectedIndex = -1;
		document.getElementById("secondDropdown").selectedIndex = -1;
		document.getElementById("thirdDropdown").selectedIndex = -1;

		document.getElementById('instructions').innerHTML = 'You\'ve got three votes—who was best, who was worst, and who was just okay?'
		document.getElementById('round4').style.display = 'inherit';

	});

	function submitStoryVotes() {
		var op1 = document.getElementById('firstDropdown');
		var op2 = document.getElementById('secondDropdown');
		var op3 = document.getElementById('thirdDropdown');

		var index1 = op1.selectedIndex
		var index2 = op2.selectedIndex
		var index3 = op3.selectedIndex

		if (index1 == -1 || index2 == -1 || index3 == -1) {
			document.getElementById('errorVote').style.display = 'inherit';
			document.getElementById('errorVote').innerHTML = 'Error: please use all your votes.'
		} else if (index1 == index2 || index2 == index3 || index1 == index3) {
			document.getElementById('errorVote').style.display = 'inherit';
			document.getElementById('errorVote').innerHTML = 'Error: you may give each player at most one vote.'
		} else {
			var place1 = op1.options[op1.selectedIndex].value;
			var place2 = op2.options[op2.selectedIndex].value;
			var place3 = op3.options[op3.selectedIndex].value;

			socket.emit('addVotes', {place1, place2, place3})
			document.getElementById('round4').style.display = 'none';
			document.getElementById('instructions').innerHTML = 'I bet you won.'
			document.getElementById('waitingScreen').style.display = 'inherit';
		}
	};

	socket.on('addContinueButton', function(data) {
		document.getElementById('continueButton').style.display = 'inherit';
	});

	function nextStory() {
		socket.emit('continueDisplayStory')
	};

	function doneWithGame() {
		socket.emit('gameOver')
	};

	socket.on('finishGame', function(data) {
		document.getElementById('round5').style.display = 'none';
		document.getElementById('winningStory').innerHTML = data.winningStory;
		document.getElementById('winningStoryTitle').innerHTML = data.winningStoryTitle;
		document.getElementById('winningStoryShortname').innerHTML = "By: " + data.winningStoryShortname;
		document.getElementById('instructions').innerHTML = 'Here\'s what your winner wrote. Pretty good, right?'
		document.getElementById('round8').style.display = 'grid';
	});

	socket.on('addPlayAgainButton', function() {
		document.getElementById('playAgainButton').style.display = 'inherit';
		document.getElementById('returnLobbyButton').style.display = 'inherit';
	})

	function playAgain() {
		socket.emit('playGameAgain')
	};

	function invertGameDisplay() {
		document.getElementById('startMenu').style.display = 'inherit';
		document.getElementById('headerBig').style.display = 'inherit';
		document.getElementById('credits').style.display = 'inherit';
		document.getElementById('headerSmall').style.display = 'none';
		document.getElementById('gameMenu').style.display = 'none';
	}

	socket.on('lastRoundWinnerStoryHide', function() {
		document.getElementById('waitingText').innerHTML = ''
		document.getElementById('waitingScreen').style.display = 'none'
	})

	socket.on('backToLobbyNewGameHost', function(data) {
		trashOldGame()
		var shortname = document.getElementById('shortnameID').innerHTML
		document.getElementById('playersList').innerHTML = 'Players in lobby:' + data.shortnamesList
		createdLobby(shortname)
		invertGameDisplay()
		document.getElementById('startMenu').style.display = 'flex'
	})

	socket.on('backToLobbyNewGame', function() {
		trashOldGame()
		joinedLobbyFunction()
		invertGameDisplay()
		document.getElementById('startMenu').style.display = 'flex'
	})

	socket.on('restartGame', function() {
		trashOldGame()
	});

	function trashOldGame() {
		document.getElementById('round8').style.display = 'none';
		document.getElementById('waitingScreen').style.display = 'inherit';
		document.getElementById('instructions').innerHTML = 'To start, just answer these three questions and hit submit when you\'re done. Easy peasy.'

		var listOThings = [document.getElementById('titlesNames'), document.getElementById('playersListContainer'), document.getElementById('votingContainer')]

		for (var j = 0; j < listOThings.length; j++) {
			const doodad = listOThings[j]
			while (doodad.firstChild) {
				doodad.removeChild(doodad.firstChild);
			}
		}

		var listODropdowns = [document.getElementById('firstDropdown'), document.getElementById('secondDropdown'), document.getElementById('thirdDropdown')]

		for (var j = 0; j < listODropdowns.length; j++) {
			var select = listODropdowns[j]
			var length = select.options.length;
			for (i = length-1; i >= 0; i--) {
				select.options[i] = null;
			}
		}

		document.getElementById('finalScreenContinue').style.display = 'none'
		document.getElementById('errorNotEnoughPlayers').style.display = 'none'
		
		playerCounter = 0;
	}

	function send_emoji(score) {
		var spotlightPlayer = document.getElementById('spotlightID').innerHTML;
		socket.emit('emojiButtonPress', {score, spotlightPlayer})
		document.getElementById('votingButton1').disabled = true;
		document.getElementById('votingButton2').disabled = true;
		document.getElementById('votingButton3').disabled = true;
	};

	socket.on('donePlayers', function(data) {
		if (data.first_bool == true) {
			document.getElementById('waitingText').setAttribute('class', 'col1-row1 autoMargin card funFactMode')
			document.getElementById('waitingText').innerHTML = 'Did you know? ' + data.fun_fact;
		}

		var newElement = document.createElement('A');
		newElement.innerHTML = data.shortName;
		newElement.setAttribute('id',data.shortName);
		newElement.setAttribute('class','donePlayer card');
		document.getElementById('listPlayers').appendChild(newElement);
	});

	function changeError(errorMessage) {
		var errorElement = document.getElementById('errorMsg');
		errorElement.style.display = 'block';
		errorElement.innerHTML = errorMessage;
	};

	function initializeTimer(timeLeft, callbackFunction, timerID, waitingBool, timer_path_remaining) {
		stopTimer();
		var timePassed = 0

		if (waitingBool) {
			document.getElementById(timerID).setAttribute('class', 'col1-row1 autoMargin card waitingTimer pbr-text-blue')
    		document.getElementById(timerID).innerHTML = 'Starting round in ' + timeLeft + '...'
    	} else {
    		document.getElementById(timerID).innerHTML = formatTimeLeft(timeLeft);
    	}

		startTimer(timeLeft, timePassed, timeLeft, callbackFunction, timerID, waitingBool, timer_path_remaining);
	}

	var timerInterval = null;
	
	function startTimer(amountOfTime, timePassed, timeLeft, callbackFunction, timerID, waitingBool, timer_path_remaining) {
	  	timerInterval = setInterval(() => {
	  		
		    // The amount of time passed increments by one
		    timePassed = timePassed += 1;
		    timeLeft = amountOfTime - timePassed;
		    setCircleDasharray(timeLeft, amountOfTime, timer_path_remaining);
		    
		    // The time left label is updated
		    if (timeLeft == 0) {
		    	if (waitingBool) {
		    		document.getElementById(timerID).innerHTML = ''
		    		document.getElementById(timerID).setAttribute('class', 'col1-row1 autoMargin card funFactMode')
		    	} else {
		    		document.getElementById('timeOut').innerHTML = 'true'
		    	}
		    	
		    	clearInterval(timerInterval);
		    	callbackFunction();
		    } else {
		    	if (waitingBool) {
		    		document.getElementById(timerID).innerHTML = 'Starting round in ' + timeLeft + '...'
		    	} else {
		    		timeLeft = formatTimeLeft(timeLeft)
		    		document.getElementById(timerID).innerHTML = timeLeft;
		    	}
		    }

		}, 1000);
	}

	function formatTimeLeft(time) {
		// The largest round integer less than or equal to the result of time divided being by 60.
		const minutes = Math.floor(time / 60);

		// Seconds are the remainder of the time divided by 60 (modulus operator)
		let seconds = time % 60;

		// If the value of seconds is less than 10, then display seconds with a leading zero
		if (seconds < 10) {
			seconds = `0${seconds}`;
		}

		// The output in MM:SS format
		return `${minutes}:${seconds}`;
	};

	// Divides time left by the defined time limit.
	function calculateTimeFraction(timeLeft, TIME_LIMIT) {
		const rawTimeFraction = timeLeft / TIME_LIMIT;
  		return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
	}

	// Update the dasharray value as time passes, starting with 283
	function setCircleDasharray(timeLeft, amountOfTime, timer_path_remaining) {
	  const circleDasharray = `${(calculateTimeFraction(timeLeft, amountOfTime) * 283).toFixed(0)} 283`;
	  document.getElementById(timer_path_remaining).setAttribute("stroke-dasharray", circleDasharray);
	}

	function stopTimer() {
		clearInterval(timerInterval);
	}

	function toggleSettings() {
		var menu = document.getElementById('settingsMenu');
		if (menu.style.display === "none") {
			menu.style.display = "grid";
			document.getElementById('showGameSettings').innerHTML = 'Hide options';
		} else {
			menu.style.display = "none";
			document.getElementById('showGameSettings').innerHTML = 'Options';
		}
	}

	function showInstructions() {
		var instructions = document.getElementById('howToPlay');

		if (instructions.style.display === "none") {
			instructions.style.display = "inherit";
			document.getElementById('showGameInstructions').innerHTML = 'Hide instructions'
		} else {
			instructions.style.display = "none";
			document.getElementById('showGameInstructions').innerHTML = 'Instructions'
		}
	}

	function lobbyGame() {
		socket.emit('returnGameToLobby')
	}

	socket.on('notEnoughPlayers', function() {
		document.getElementById('errorNotEnoughPlayers').style.display = 'inherit'
	});

	function toggleAudioSettings(itemID) {
		if ($(itemID).css('display') == 'none') {
			$(itemID).css('display', 'block')
		} else {
			$(itemID).css('display', 'none')
		}
	}

	function musicOff() {
		$('audio#music')[0].pause()
		$('#music_on').css('display', 'none')
		$('#music_off').css('display', 'block')
	}

	function musicOn() {
		$('audio#music')[0].play()
		$('#music_off').css('display', 'none')
		$('#music_on').css('display', 'block')
	}

	window.SetVolume = function(val) {
		var player = document.getElementById('music');
		player.volume = val / 100;
	}

</script>

<body>
	<div id='forDevEyesOnly' style='display:none;'>
		<a id='timeOut'>false</a>
		<a id='dummy'></a>
		<a id='shortnameID'></a>
		<a id='cannedAnswer1'></a>
		<a id='cannedAnswer2'></a>
		<a id='cannedAnswer3'></a>
	</div>
	<button id='audioSett' onclick='toggleAudioSettings("#audioMenu")' class="mdc-icon-button material-icons" style='font-size:60px;position:absolute;right:0;top:0;color:#686868;margin:10px;border:none;background-color:transparent;'>settings</button>
	<div id='audioMenu' class='card' style='display:none;width:auto;z-index:10;position:absolute;right:0;margin-right:20px;top:90px;'>
		<button id='music_on' onclick='musicOff()' class='mdc-icon-button material-icons' style='display:block;margin:auto;margin-top:20px;font-size:60px;border:none;background-color:transparent;'>music_note</button>
		<button id='music_off' onclick='musicOn()' class='mdc-icon-button material-icons' style='display:none;margin:auto;margin-top:20px;font-size:60px;border:none;background-color:transparent;'>music_off</button>
		<input id="vol-control" type="range" min="0" max="100" value='100' step="1" oninput="SetVolume(this.value)" onchange="SetVolume(this.value)" style='margin:20px;'></input>
	</div>
	<div id='smallDeviceAlert'>
		<a>We've detected you're using a handheld device. Features may not display properly.</a>
	</div>
	<div id='headerBig' class='titleBig headerFont'>
		<a href='http://www.palabr.io'class= 'pbr-text-large' style='text-decoration:none;'><span class='pbr-text-blue'>palabr</span>.<span class='pbr-text-red'>io</span></a>
	</div>
	<div id='headerSmall' class='titleSmall headerFont' style='display: none;'>
		<a href='http://www.palabr.io'class= '' style='text-align:left;text-decoration:none;'><span class='pbr-text-blue'>palabr</span>.<span class='pbr-text-red'>io</span></a>
	</div>
	<audio loop id='music'>
		<source src='/client/palabriotheme.mp3' type='audio/mpeg'>
	</audio>
	<!-- music by Colin Winkelmann -->

	<div id='startMenu' class='card menuStart'>
		<a id='welcomeText' class='boxText'>Come flex your creative muscles and get to know your friends! Click the button below to create a private game, or input a game ID to join an existing one.</a>

		<div id='startInputInfo' class='initialStartGrid'>
			<input id = 'username' placeholder = 'Username' class='inputBox col1-row1' maxlength="12"></input>
			<a id='afterCreatedUsername' style='display:none;' class='pbr-text-blue centerText'></a>
			<button id = 'btnLobby' onclick="create_lobby()" class='pbr-yellow button col2-row1'>Create Game</button>
			<button id = 'startGame' onclick="start_game()" class='pbr-yellow button col2-row1' style = "display: none;">Start Game</button>
			<input id = 'joinCode' placeholder = 'Game ID' class='inputBox col1-row2'></input>
			<a id = 'shareCode' class= 'pbr-text-blue col1-row2 centerText' style = 'display: none'></a>
			<button id = 'btnJoinExisting' onclick="join_game()" class='pbr-yellow button col2-row2'>Join Game</button>
			<button id = 'copyGameCode' onclick='copy_code()' class='pbr-grey button col2-row2' style='display:none;'>Copy Code</button>
		</div>

		<a id ='lobbyJoin' class='pbr-text-blue centerText' style = 'display: none;flex-grow:1;margin:20px 20px 20px 20px;width:100%'></a>
		<a id = 'playersList' class= 'pbr-text-blue centerText' style = 'display: none;flex-grow:1;margin:0px 20px 20px 20px;width:100%'></a>
		<a id = 'errorMsg' class= 'pbr-text-red centerText' style = 'display: none;flex-grow:1;margin:0px 20px 20px 20px;width:100%'></a>


		<a id='howToPlay' class='pbr-text-blue' style='padding:0px 20px 20px 20px;display:none;font-size:14px;'>Palabr.io has three rounds. For the first round, you will answer three questions. Next, you will receive the answers from another player and incorporate those into a story. After voting on who was best, you will take those answers you received and write questions that make the answers sound ridiculous. Have fun!</a>

		<div id='settingsMenu' class='settingsMenu' style='display:none;padding:10px;'>
			<label class='switch col2-row1'>
				<input id='familyFilter' type='checkbox' checked >
				<span class='slider round'></span>
			</label>
			<a class='pbr-text-blue' style='grid-column:3;grid-row:1;'>Family-friendly filter</a>
			<label class='switch col2-row2'>
				<input id='getToKnowYouFilter' type='checkbox'>
				<span class='slider round'></span>
			</label>
			<a class='pbr-text-blue' style='grid-column:3;grid-row:2;'>Get-to-know-you mode</a>
		</div>

		<div id='optionsInstructions' style='margin:auto;margin-bottom:10px;'>
			<button id='showGameSettings' class='buttonLink' onclick='toggleSettings()' style='color:#686868'>Options</button>
			<button id='showGameInstructions' onclick='showInstructions()' class='buttonLink' style='color:#686868'>Instructions</button>
		</div>

	</div>

	<div id='gameMenu' class='card menuGame' style='display: none;min-height:450px;min-width:800px;'>
		<div class= 'gameMenuGrid'>

			<div id='instructionsContainer' style='grid-column: 1 / 3;grid-row: 1;text-align: center; padding: 1.5% 0;border-bottom:2px solid #9e9e9e;'>
				<a id='instructions'>To start, just answer these three questions and hit submit when you're done. Easy peasy.</a>
			</div>

			<div id='playersListContainer' class='playersListGrid col1-row2 centerText' style='border-right:2px solid #9e9e9e;'>

			</div>

			<div id='waitingScreen' class='waitingGrid col2-row2'>
				<a id='waitingText' class='col1-row1 autoMargin card funFactMode'></a>
				<div id='listPlayers' class='col1-row2 autoMargin'></div>
			</div>

			<div id='round1' class='questionsRoundGrid col2-row2 centerText'  style='display:none;'>
				<a id='question1' class= 'pbr-text-blue col1-row1 autoMargin'></a>
				<input id='answer1' class='inputGame col1-row2' maxlength="35"></input>
				<a id='question2' class= 'pbr-text-blue col1-row3 autoMargin'></a>
				<input id='answer2' class='inputGame col1-row4' maxlength="35"></input>
				<a id='question3' class= 'pbr-text-blue col1-row5 autoMargin'></a>
				<input id='answer3' class='inputGame col1-row6' maxlength="35"></input>
				<a id='needAnswers' class='pbr-text-red col1-row7' style='display:none;'>Please answer all the questions.</a>
				<div class='rightSideGridContainer' style='grid-column:2;grid-row:1 / 8'>

					<div class="base-timer">
						<svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
							<g class="base-timer__circle">
							  <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45" />
							  <path id="base-timer-path-remaining" stroke-dasharray="283" class="base-timer__path-remaining" style='color:green;'
						        d="
						          M 50, 50
						          m -45, 0
						          a 45,45 0 1,0 90,0
						          a 45,45 0 1,0 -90,0
						        "
						      ></path>
							</g>
						</svg>
						<span>
							<a id='countdownTimerRound1' class='col1-row1 base-timer__label'></a>
						</span>
					</div>
					<button id='submitButton' onclick="send_ans()" class='pbr-yellow button col1-row2' style='height:35px;width:80px'>Submit</button>
				</div>
			</div>

			<div id='round2' class='storyRoundGrid col2-row2 centerText' style='display: none;'>
				<a id='useAnswers' class='pbr-text-blue col1-row1 autoMargin'></a>
				<textarea id='story' class='inputStory col1-row2' maxlength="1100"></textarea>
				<input id='storyTitle' placeholder='story title' class='inputGame col1-row3'style='font-size:15px;width:50%;margin-left:25%;' maxlength='60'></input>
				<a id='needInfo' class='pbr-text-red col1-row4' style='display:none;'></a>

				<div class='rightSideGridContainer' style='grid-column:2;grid-row:1 / 5'>

					<div class="base-timer">
						<svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
							<g class="base-timer__circle">
							  <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45" />
							  <path id="base-timer-path-remaining1" stroke-dasharray="283" class="base-timer__path-remaining" style='color:green;'
						        d="
						          M 50, 50
						          m -45, 0
						          a 45,45 0 1,0 90,0
						          a 45,45 0 1,0 -90,0
						        "
						      ></path>
							</g>
						</svg>
						<span>
							<a id='countdownTimerRound2' class='col1-row1 base-timer__label'></a>
						</span>
					</div>
					<button id='submitButton' onclick="send_story()" class='pbr-yellow button col1-row2' style='height:35px;width:80px'>Submit</button>
				</div>

			</div>

			<div id='round3' class='storyDisplayGrid col2-row2 centerText'style='display: none;'>
				<div id='titleNameStoryBox' class='col1-row1 titleNameStoryBoxClass'>
					<a id='titleStory' class = 'titleDisplay card'></a>
					<a id='storyAuthor' class='authorDisplay card'></a>
					<a id='storyDisplay' class='storyDisplay card'></a>
				</div>
				<button id='continueButton' onclick='nextStory()' class='pbr-yellow button col2-row2' style='height:35px;width:90px;display: none;'>Continue</button>
			</div>

			<div id='round4' class='storyVotingDisplayGrid col2-row2 centerText'style='display: none;'>
				<div id='titlesNames' class='autoMargin'style='grid-column:1;grid-row:1'></div>

				<div class='rightSideVotingContainer' style='grid-column:2;grid-row:1'>
					<a class='col1-row1'></a>
					<a id = 'firstTitle' class='pbr-text-blue col1-row2 autoMargin'>1st</a>
					<select id='firstDropdown' class='col1-row3 votingDropdown autoMargin'></select>
					<a id = 'secondTitle' class='pbr-text-blue col1-row4 autoMargin'>2nd</a>
					<select id='secondDropdown' class='col1-row5 votingDropdown autoMargin'></select>
					<a id = 'thirdTitle' class='pbr-text-blue col1-row6 autoMargin'>3rd</a>
					<select id='thirdDropdown' class='col1-row7 votingDropdown autoMargin'></select>
					<a id='errorVote' class='col1-row8 pbr-text-red' style='font-size:12px;display:none;'></a>
					<button id='submitStoryVotes' onclick='submitStoryVotes()' class='pbr-yellow button col1-row9' style='height:35px;width:80px;margin-left:40%'>Submit</button>
				</div>
			</div>

			<div id='round5' class='scoresGrid col2-row2 centerText' style='display: none'>
				<div id='votingContainer' class='col1-row1 autoMargin'></div>
				<button id='scoresContinue' onclick='doneWithScores()' class='pbr-yellow button col2-row2' style='height:35px;width:90px;display:none;'>Continue</button>
				<button id='finalScreenContinue' onclick='doneWithGame()' class='pbr-yellow button col2-row2' style='height:35px;width:80px;display:none;'>Finish</button>
			</div>

			<div id='round6' class='questionsRoundGrid col2-row2 centerText' style='display: none;'>
				<a id='answer11' class= 'pbr-text-blue col1-row2 autoMargin'></a>
				<input id='question11' class='inputQuestions col1-row1 autoMargin' maxlength='120'></input>
				<a id='answer21' class= 'pbr-text-blue col1-row4 autoMargin'></a>
				<input id='question21' class='inputQuestions col1-row3 autoMargin' maxlength='120'></input>
				<a id='answer31' class= 'pbr-text-blue col1-row6 autoMargin'></a>
				<input id='question31' class='inputQuestions col1-row5 autoMargin' maxlength='120'></input>
				<a id='needAnswers1' class='pbr-text-red col1-row7 centerText' style='display:none;'>Please submit all the questions.</a>

				<div class='rightSideGridContainer' style='grid-column:2;grid-row:1 / 8'>

					<div class="base-timer">
						<svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
							<g class="base-timer__circle">
							  <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45" />
							  <path id="base-timer-path-remaining2" stroke-dasharray="283" class="base-timer__path-remaining" style='color:green;'
						        d="
						          M 50, 50
						          m -45, 0
						          a 45,45 0 1,0 90,0
						          a 45,45 0 1,0 -90,0
						        "
						      ></path>
							</g>
						</svg>
						<span>
							<a id='countdownTimerRound6' class='col1-row1 base-timer__label'></a>
						</span>
					</div>
					<button id='submitButton1' onclick="send_questions()" class='pbr-yellow button col1-row2' style='height:35px;width:80px'>Submit</button>
				</div>

			</div>

			<div id='round7' class='questionsDisplayGrid col2-row2 centerText'style='display: none;'>

				<div id='questionDisplayFlexBox' class='col1-row1'>
					<a id='spotlightID' style='display:none;'></a>
					<a id='realQuestion' class='pbr-text-blue'></a>
					<a id='realAnswer' class='pbr-text-blue'></a>
					<a id='fakeQuestion' class='pbr-text-blue'></a>
				</div>

				<div id='emojiButtonsDashboard' style='grid-column:2;grid-row:1;'>
					<a class='col1-row1'></a>
					<button id='votingButton1' class='emojiButton card' class='col1-row2' onclick="send_emoji(100)">🤣</button>
					<button id='votingButton2' class='emojiButton card' class='col1-row3' onclick="send_emoji(50)">😎</button>
					<button id='votingButton3' class='emojiButton card' class='col1-row4' onclick="send_emoji(25)">👍</button>

					<button id='continueButtonQuestion' onclick='nextQuestion()' class='pbr-yellow button col1-row5' style='height:35px;width:90px;display: none;'>Continue</button>
				</div>

				
			</div>

			<div id='round8' class='col2-row2 centerText round8grid' style='display:none'>
				<div class='titleNameStoryBoxClass' style='grid-column:1;grid-row:1 / 3'>
					<a id='winningStoryTitle' class='titleDisplay card'></a>
					<a id='winningStoryShortname' class='authorDisplay card'></a>
					<a id='winningStory' class='storyDisplay card'></a>
				</div>
				<div style='display:flex;flex-direction:column;grid-column:2'>
					<button id='returnLobbyButton' class ='pbr-yellow button' style='height:35px;width:125px;margin-bottom:30px;display:none;' onclick='lobbyGame()'>Return to Lobby</button>
					<button id='playAgainButton' class ='pbr-yellow button' style='height:35px;width:95px;display:none;' onclick='playAgain()'>Play Again</button>
				</div>
				
				<a id='errorNotEnoughPlayers' style='display:none;color:red;'>Error: after removing ghost players, there are not enough players to play another game. Please return to lobby.</a>

			</div>

		</div>
	</div>

	<div id='credits' class='footer'>
		<a class='pbr-text-small'>Created by <span class='pbr-text-blue'>Kevin Lauer</span> and <span class='pbr-text-red'>Emily Lucas</span></a>
	</div>

</body>

</html>